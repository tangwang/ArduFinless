# 02｜硬件与系统架构（基于 ArduFinless）

## 1. 本项目的硬件基线

根据仓库说明，默认硬件为：
- 主控：Arduino Mega 2560
- 侧滑角传感器：AS5047P（磁编码器）
- 陀螺仪：MPU6500
- 舵机与动力设备参考清单见 README

你还可以在 README 的图中查看机体、传感器结构和接线示意。

## 2. 系统模块图（文字版）

- **输入层**：RC PWM（Yaw/Brake）
- **状态层**：AS5047P（角度）+ MPU6500（角速度）
- **算法层**：滤波 + 控制律（Beta 与 Yaw Rate 反馈）
- **执行层**：左右阻力舵 PWM 输出
- **配置层**：串口命令 + EEPROM 持久化参数

## 3. 引脚与外设分工

主程序定义了关键片选引脚：
- `ENCODER_CS_PIN = 49`
- `IMU_CS_PIN = 48`

PWM 输入/输出引脚在 `PWM_IO.h` 中集中定义：
- 输入：2/3/18/19（外部中断）
- 输出：11/12/8/7（定时器 PWM）

这意味着它在 Mega 上充分利用了“外部中断 + 硬件定时器”，适合实时控制。

## 4. SPI 总线上的两个传感器

项目中两个传感器共享 SPI，但工作模式不同：
- AS5047P 用 `SPI_MODE1`
- MPU6500 用 `SPI_MODE3`

代码中在各自读写前切换模式，这一点很关键，避免总线配置冲突。

## 5. 数据路径（从硬件到控制输出）

1. 传感器读取：
   - 编码器给出角度（Beta 原始）
   - 陀螺仪给出 Z 轴角速度（Yaw Rate 原始）
2. RC 输入读取：Yaw 与 Brake 通道
3. 低通滤波：减小噪声
4. 控制律计算：得到左右舵归一化输出
5. PWM 映射与限幅：输出到舵机

## 6. 新手接线与验证建议

- 首先只验证“串口可通信 + 传感器初始化通过”。
- 再验证“RC 输入有效并且方向正确”。
- 最后验证“舵机输出方向、限位、中心位”。

不要跳步。飞控工程里，跳步是最常见故障源。
